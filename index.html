<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>QR Scanner - Nimiq</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Scanner ES5 UMD Version -->
    <script src="https://cdn.jsdelivr.net/npm/qr-scanner@1.4.2/qr-scanner.umd.min.js"></script>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col items-center justify-start p-6">
    <h1 class="text-2xl font-bold mb-4">QR Code Scanner</h1>

    <div class="bg-white p-4 rounded-lg shadow-md w-full max-w-md space-y-4">
      <select id="camera-select" class="w-full p-2 border border-gray-300 rounded text-sm"></select>

      <div class="relative w-full h-60 rounded overflow-hidden">
        <video id="qr-video" class="w-full h-full object-cover"></video>
        <!-- Frame Overlay -->
        <div class="absolute top-0 left-0 w-full h-full pointer-events-none">
          <div class="absolute border-t-4 border-l-4 border-white w-6 h-6 top-2 left-2"></div>
          <div class="absolute border-t-4 border-r-4 border-white w-6 h-6 top-2 right-2"></div>
          <div class="absolute border-b-4 border-l-4 border-white w-6 h-6 bottom-2 left-2"></div>
          <div class="absolute border-b-4 border-r-4 border-white w-6 h-6 bottom-2 right-2"></div>
        </div>
      </div>

      <div class="flex justify-center gap-4">
        <button id="start-btn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">Start Scanner</button>
        <button id="stop-btn" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">Stop Scanner</button>
      </div>

      <div id="qr-result" class="hidden text-center text-sm bg-gray-100 p-2 rounded"></div>

      <div class="text-center">
        <button id="open-link-btn" disabled class="mt-2 bg-gray-400 text-white px-4 py-2 rounded text-sm cursor-not-allowed">Buka Link dari QR</button>
      </div>
    </div>

    <script>
      const videoElem = document.getElementById("qr-video");
      const selectElem = document.getElementById("camera-select");
      const openLinkBtn = document.getElementById("open-link-btn");
      let scanner;
      let currentResult = "";

      QrScanner.listCameras(true).then((cameras) => {
        cameras.forEach((cam) => {
          const opt = document.createElement("option");
          opt.value = cam.id;
          opt.textContent = cam.label || "Unnamed Camera";
          selectElem.appendChild(opt);
        });

        if (cameras.length > 0) {
          selectElem.value = cameras[0].id;
        }
      });

      selectElem.addEventListener("change", () => {
        restartScanner();
      });

      document.getElementById("start-btn").addEventListener("click", () => startScanner());
      document.getElementById("stop-btn").addEventListener("click", () => stopScanner());
      openLinkBtn.addEventListener("click", () => {
        if (currentResult && isValidUrl(currentResult)) {
          window.open(currentResult, "_blank");
        }
      });

      function isValidUrl(str) {
        try {
          const url = new URL(str);
          return url.protocol === "http:" || url.protocol === "https:";
        } catch {
          return false;
        }
      }

      async function startScanner() {
        stopScanner();

        const selectedId = selectElem.value;
        scanner = new QrScanner(
          videoElem,
          (result) => {
            console.log("QR Detected:", result);
            currentResult = result;
            showResult(result);
          },
          {
            returnDetailedScanResult: false,
            highlightScanRegion: true,
            preferredCamera: selectedId,
          }
        );

        await scanner.start();
      }

      function stopScanner() {
        if (scanner) {
          scanner.stop();
          scanner.destroy();
          scanner = null;
        }
      }

      function restartScanner() {
        stopScanner();
        startScanner();
      }

      function showResult(text) {
        const resultElem = document.getElementById("qr-result");
        resultElem.classList.remove("hidden");

        if (isValidUrl(text)) {
          resultElem.innerHTML = `
            ðŸ”— Link terdeteksi:<br>
            <span class="text-blue-600 break-words underline">${text}</span>
          `;
          openLinkBtn.disabled = false;
          openLinkBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
          openLinkBtn.classList.add("bg-green-600", "hover:bg-green-700", "cursor-pointer");
        } else {
          resultElem.innerHTML = `
            ðŸ“„ QR berisi teks:<br>
            <strong>${text}</strong>
          `;
        }
      }
    </script>
  </body>
</html>
